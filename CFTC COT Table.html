<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>COT Historical Data Table - Resizable</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Ensure html and body take full viewport height and width of the iframe */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #f0f0f0;
            font-family: 'Source Code Pro', monospace;
            height: 100%; /* Takes full height of its container (iframe) */
            width: 100%;  /* Takes full width of its container (iframe) */
            overflow: hidden; /* Prevent scrollbars on body itself, manage scrolling in specific containers */
        }

        body {
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Stack children vertically */
            /* height: 100%; redundant as html,body already has it, but explicit for clarity */
        }

        .widget-container {
            display: flex;
            flex-direction: column;
            flex: 1; /* Allows this container to grow and shrink to fill available space in body */
            padding: 0;
            box-sizing: border-box;
            background-color: #000;
            border: 1px solid #222; /* This border is part of the widget look */
            border-radius: 0; /* Assuming this is desired for iframe content */
            overflow: hidden; /* Prevent this container from showing scrollbars; children will manage their own */
            min-height: 0; /* Crucial for flex children to shrink properly and allow internal scrolling */
        }

        .widget-title-bar {
            height: 30px; /* Fixed height for the title bar */
            display: flex;
            align-items: center;
            justify-content: flex-start;
            background-color: #1a1a1a;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #222;
            padding-left: 12px;
            flex-shrink: 0; /* Prevents the title bar from shrinking */
        }

        .content-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1; /* Takes remaining space in .widget-container */
            padding: 16px;
            gap: 15px;
            box-sizing: border-box;
            overflow: hidden; /* Wrapper itself doesn't scroll; table-container will */
            min-height: 0; /* Allows shrinking and internal scrolling for children */
        }

        .controls-wrapper {
            display: flex;
            align-items: center;
            gap: 15px; 
            padding-bottom: 10px;
            flex-shrink: 0; /* Controls have a fixed height based on content */
            flex-wrap: wrap; /* Allow controls to wrap on smaller widths */
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .controls-wrapper label {
            font-size: 12px;
            color: #ccc;
        }

        .controls-wrapper select {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            color: #eee;
            padding: 6px 10px;
            font-size: 12px;
            font-family: 'Source Code Pro', monospace;
            cursor: pointer;
            outline: none;
        }

        .controls-wrapper select:hover {
            border-color: #ff8000;
        }

        /* Minimalist macOSâ€“Style Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255,255,255,0.2);
        }
        /* For Firefox */
        html {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }
        
        .table-container {
            flex: 1; /* Takes all available vertical space in .content-wrapper */
            overflow-y: auto; /* Allows vertical scrolling for the table content if it overflows */
            overflow-x: auto; /* Allows horizontal scrolling if table content is too wide */
            min-height: 0; /* Essential for flexbox to allow scrolling within this container */
            border: 1px solid #222;
            border-radius: 4px;
        }

        table {
            width: 100%; /* Table takes full width of its container */
            border-collapse: collapse;
            font-size: 12px; 
        }

        th, td {
            border-bottom: 1px solid #222; 
            border-left: 1px solid #222;
            padding: 7px; 
            text-align: right; 
            vertical-align: middle;
            white-space: nowrap; /* Prevents text wrapping in cells, good for tabular data */
        }
        th:first-child, td:first-child {
            text-align: left; /* Date column left-aligned */
            border-left: none; /* Remove double border on the left */
        }
         td:first-child {
            color: #e0e0e0; /* Date color */
         }

        th {
            background-color: #1a1a1a; 
            color: #ff8000;
            position: sticky; /* Makes table headers sticky during vertical scroll */
            top: 0; 
            z-index: 10; /* Ensures headers stay above scrolling content */
        }
        
        td {
            color: #bbb; 
        }
        
        tr:nth-child(even) {
            background-color: #080808; 
        }
        tr:hover {
            background-color: #151515; 
        }
        .positive { color: #4CAF50; } /* Green for positive numbers */
        .negative { color: #F44336; } /* Red for negative numbers */

    </style>
</head>
<body>
<div class="widget-container">
    <div class="widget-title-bar">COT Historical Data Table</div>
    <div class="content-wrapper">
        <div class="controls-wrapper">
            <div class="control-group">
                <label for="instrument-select">Instrument:</label>
                <select id="instrument-select"></select>
            </div>
            <div class="control-group">
                <label for="trader-type-select">Trader Type:</label>
                <select id="trader-type-select">
                    <option value="all">All Trader Types</option>
                    <option value="leveragedFund">Leveraged Fund</option>
                    <option value="assetManager">Asset Manager</option>
                    <option value="dealer">Dealer</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table id="cot-historical-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Long</th>
                        <th>Short</th>
                        <th>Net Position</th>
                        <th>Open Interest</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const instrumentSelect = document.getElementById('instrument-select');
    const traderTypeSelect = document.getElementById('trader-type-select');
    const historicalTableBody = document.getElementById('cot-historical-table').getElementsByTagName('tbody')[0];

    // --- Data Generation Functions (Unchanged) ---
    function generateRandomCotEntry(baseDate, weekOffset, instrumentType) {
        const date = new Date(baseDate);
        date.setDate(date.getDate() + weekOffset * 7);
        const dateString = date.toISOString().split('T')[0];

        let lfLongBase = 150000, amLongBase = 200000, dLongBase = 250000;
        let lfShortBase = 150000, amShortBase = 200000, dShortBase = 250000;

        if (instrumentType === 'GOLD') {
            lfLongBase = 280000; amLongBase = 50000; dLongBase = 180000;
            lfShortBase = 70000; amShortBase = 300000; dShortBase = 350000;
        } else if (instrumentType === 'EURUSD') {
            lfLongBase = 90000; amLongBase = 150000; dLongBase = 160000;
            lfShortBase = 150000; amShortBase = 120000; dShortBase = 110000;
        } else if (instrumentType === 'OIL') {
            lfLongBase = 350000; amLongBase = 80000; dLongBase = 400000;
            lfShortBase = 280000; amShortBase = 100000; dShortBase = 450000;
        } else if (instrumentType === 'SP500') {
            lfLongBase = 100000; amLongBase = 400000; dLongBase = 50000;
            lfShortBase = 120000; amShortBase = 380000; dShortBase = 70000;
        } else if (instrumentType === 'GBPUSD') {
            lfLongBase = 60000; amLongBase = 40000; dLongBase = 50000;
            lfShortBase = 70000; amShortBase = 50000; dShortBase = 40000;
        } else if (instrumentType === 'USDJPY') { 
            lfLongBase = 20000; amLongBase = 80000; dLongBase = 100000;
            lfShortBase = 100000; amShortBase = 30000; dShortBase = 20000;
        } else if (instrumentType === 'AUDUSD') {
            lfLongBase = 40000; amLongBase = 30000; dLongBase = 20000;
            lfShortBase = 30000; amShortBase = 40000; dShortBase = 25000;
        } else if (instrumentType === 'COPPER') {
            lfLongBase = 50000; amLongBase = 20000; dLongBase = 30000;
            lfShortBase = 40000; amShortBase = 30000; dShortBase = 20000;
        }
        
        const trendFactor = Math.sin(weekOffset / 10) * 0.2 + 1; 
        const noiseFactor = () => (Math.random() - 0.5) * 0.15 + 1; 

        const lfLong = Math.floor(lfLongBase * trendFactor * noiseFactor());
        const lfShort = Math.floor(lfShortBase * (2 - trendFactor) * noiseFactor());
        const amLong = Math.floor(amLongBase * trendFactor * noiseFactor());
        const amShort = Math.floor(amShortBase * (2 - trendFactor) * noiseFactor());
        const dLong = Math.floor(dLongBase * (2 - trendFactor) * noiseFactor());
        const dShort = Math.floor(dShortBase * trendFactor * noiseFactor());
        
        const openInterest = lfLong + amLong + dLong + lfShort + amShort + dShort;

        return {
            date: dateString,
            leveragedFund: { long: Math.max(0, lfLong), short: Math.max(0, lfShort) },
            assetManager: { long: Math.max(0, amLong), short: Math.max(0, amShort) },
            dealer: { long: Math.max(0, dLong), short: Math.max(0, dShort) },
            openInterest: Math.max(0, openInterest)
        };
    }

    function generateHistoricalData(instrumentKey, numEntries = 30) {
        const data = [];
        const reportDayOffset = 2; // Tuesday
        let baseDate = new Date(); 
        // Set to the most recent Tuesday
        baseDate.setDate(baseDate.getDate() - (baseDate.getDay() - reportDayOffset + 7) % 7);
        // Go back (numEntries - 1) weeks from that Tuesday
        baseDate.setDate(baseDate.getDate() - (numEntries - 1) * 7);

        for (let i = 0; i < numEntries; i++) {
            data.push(generateRandomCotEntry(baseDate, i, instrumentKey));
        }
        return data;
    }

    const instruments = {
        EURUSD: "EUR/USD", GBPUSD: "GBP/USD", USDJPY: "JPY/USD",  AUDUSD: "AUD/USD",
        SP500: "S&P 500", GOLD: "Gold", OIL: "Crude Oil", COPPER: "Copper"
    };

    const cotDataStore = {};
    Object.keys(instruments).forEach(key => {
        cotDataStore[key] = generateHistoricalData(key);
    });

    function formatNumber(num) {
        if (Math.abs(num) >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (Math.abs(num) >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toLocaleString('en-US'); // Standard formatting for smaller numbers
    }
    
    function populateHistoricalDataTable() {
        historicalTableBody.innerHTML = ''; // Clear previous table rows
        const selectedInstrumentKey = instrumentSelect.value;
        const selectedTraderType = traderTypeSelect.value;
        const instrumentData = cotDataStore[selectedInstrumentKey];

        if (!instrumentData || instrumentData.length === 0) {
            const row = historicalTableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 5; // Adjust to the number of columns
            cell.textContent = 'No data available for this instrument.';
            cell.style.textAlign = 'center';
            return;
        }

        // Display data from newest to oldest
        const reversedData = [...instrumentData].reverse(); 

        reversedData.forEach(report => {
            let longPos, shortPos, netPos;

            if (selectedTraderType === 'all') {
                longPos = report.dealer.long + report.leveragedFund.long + report.assetManager.long;
                shortPos = report.dealer.short + report.leveragedFund.short + report.assetManager.short;
            } else {
                longPos = report[selectedTraderType].long;
                shortPos = report[selectedTraderType].short;
            }
            netPos = longPos - shortPos;

            const row = historicalTableBody.insertRow();
            row.insertCell().textContent = report.date;
            row.insertCell().textContent = formatNumber(longPos);
            row.insertCell().textContent = formatNumber(shortPos);
            
            const netPosCell = row.insertCell();
            netPosCell.textContent = formatNumber(netPos);
            netPosCell.className = netPos >= 0 ? 'positive' : 'negative';
            
            row.insertCell().textContent = formatNumber(report.openInterest);
        });
    }


    // --- Initialization ---
    function initializeWidget() {
        // Populate instrument dropdown
        Object.keys(instruments).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = instruments[key];
            instrumentSelect.appendChild(option);
        });
        instrumentSelect.value = "EURUSD"; // Default selection
        traderTypeSelect.value = "all"; // Default selection

        // Add event listeners
        instrumentSelect.addEventListener('change', populateHistoricalDataTable);
        traderTypeSelect.addEventListener('change', populateHistoricalDataTable);

        // Load initial table data
        populateHistoricalDataTable();
    }

    //  Initialize the widget when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', initializeWidget);

</script>
</body>
</html>
